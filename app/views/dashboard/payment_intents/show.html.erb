<div class="page-header">
  <h1 class="page-title">Payment Intent #<%= @payment_intent.id %></h1>
  <%= link_to "← Back to Payment Intents", dashboard_payment_intents_path, class: "link" %>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">Details</h2>
  </div>
  <div class="card-body">
    <dl class="detail-list">
      <div class="detail-item">
        <dt>Status</dt>
        <dd><span class="badge badge-<%= @payment_intent.status %>"><%= @payment_intent.status %></span></dd>
      </div>
      <div class="detail-item">
        <dt>Dispute Status</dt>
        <dd><span class="badge badge-dispute-<%= @payment_intent.dispute_status %>"><%= @payment_intent.dispute_status %></span></dd>
      </div>
      <div class="detail-item">
        <dt>Amount</dt>
        <dd><%= number_to_currency(@payment_intent.amount) %> <%= @payment_intent.currency %></dd>
      </div>
      <div class="detail-item">
        <dt>Customer</dt>
        <dd><%= @payment_intent.customer.email %> (<%= @payment_intent.customer.name %>)</dd>
      </div>
      <div class="detail-item">
        <dt>Payment Method</dt>
        <dd>
          <% if @payment_intent.payment_method %>
            <%= @payment_intent.payment_method.brand %> •••• <%= @payment_intent.payment_method.last4 %>
          <% else %>
            <span class="text-muted">None</span>
          <% end %>
        </dd>
      </div>
      <div class="detail-item">
        <dt>Refundable</dt>
        <dd><%= number_to_currency(@payment_intent.refundable_cents / 100.0) %></dd>
      </div>
      <div class="detail-item">
        <dt>Total Refunded</dt>
        <dd><%= number_to_currency(@payment_intent.total_refunded_cents / 100.0) %></dd>
      </div>
      <div class="detail-item">
        <dt>Created</dt>
        <dd><%= format_time_pacific(@payment_intent.created_at) %></dd>
      </div>
    </dl>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">Actions</h2>
  </div>
  <div class="card-body actions-card-body">
    <% pi = @payment_intent %>
    <% auth_key = SecureRandom.uuid %>
    <% capt_key = SecureRandom.uuid %>
    <% void_key = SecureRandom.uuid %>
    <% refund_key = SecureRandom.uuid %>

    <div class="actions-row">
      <div class="action-item">
        <% if pi.status == "created" %>
          <%= button_to "Authorize", authorize_dashboard_payment_intent_path(pi), method: :post, class: "btn btn-primary", params: { idempotency_key: auth_key } %>
        <% else %>
          <%= button_tag "Authorize", type: "button", disabled: true, class: "btn btn-secondary" %>
          <p class="action-helper text-muted">Requires status: created</p>
        <% end %>
      </div>

      <div class="action-item">
        <% if pi.status == "authorized" %>
          <%= button_to "Capture", capture_dashboard_payment_intent_path(pi), method: :post, class: "btn btn-primary", params: { idempotency_key: capt_key } %>
        <% else %>
          <%= button_tag "Capture", type: "button", disabled: true, class: "btn btn-secondary" %>
          <p class="action-helper text-muted">Authorize required first</p>
        <% end %>
      </div>

      <div class="action-item">
        <% if pi.status == "authorized" %>
          <%= button_to "Void", void_dashboard_payment_intent_path(pi), method: :post, class: "btn btn-secondary", params: { idempotency_key: void_key }, data: { turbo_confirm: "Void this authorization?" } %>
        <% else %>
          <%= button_tag "Void", type: "button", disabled: true, class: "btn btn-secondary" %>
          <p class="action-helper text-muted">Only authorized intents can be voided</p>
        <% end %>
      </div>
    </div>

    <div class="action-item action-item-refund">
      <% if pi.status == "captured" && pi.refundable_cents > 0 %>
        <%= form_with url: refund_dashboard_payment_intent_path(pi), method: :post, local: true, scope: :refund, class: "refund-form" do |f| %>
          <%= hidden_field_tag :idempotency_key, refund_key %>
          <%= f.label :amount_cents, "Amount (cents, blank = full refund)", class: "form-label" %>
          <%= f.number_field :amount_cents, value: nil, min: 1, placeholder: "Full refund", class: "form-input refund-amount-input" %>
          <%= f.submit "Refund", class: "btn btn-secondary" %>
        <% end %>
      <% else %>
        <p class="action-helper text-muted">
          <% if pi.status != "captured" %>
            Capture required first
          <% else %>
            Nothing refundable
          <% end %>
        </p>
      <% end %>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">Transactions</h2>
  </div>
  <div class="card-body">
    <% if @transactions.any? %>
      <table class="table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Kind</th>
            <th>Status</th>
            <th>Amount</th>
            <th>Processor Ref</th>
            <th>Failure</th>
          </tr>
        </thead>
        <tbody>
          <% @transactions.each do |transaction| %>
            <tr>
              <td><%= format_time_pacific(transaction.created_at) %></td>
              <td><span class="badge badge-<%= transaction.kind %>"><%= transaction.kind %></span></td>
              <td><span class="badge badge-<%= transaction.status %>"><%= transaction.status %></span></td>
              <td><%= number_to_currency(transaction.amount_cents / 100.0) %></td>
              <td class="text-muted"><%= transaction.processor_ref %></td>
              <td>
                <% if transaction.failure_code %>
                  <span class="text-error"><%= transaction.failure_code %>: <%= transaction.failure_message %></span>
                <% else %>
                  <span class="text-muted">—</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state">
        <p class="empty-state-text">No transactions</p>
      </div>
    <% end %>
  </div>
</div>
